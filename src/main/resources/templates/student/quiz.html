<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ã‚¯ã‚¤ã‚º</title>
    <link rel="stylesheet" th:href="@{/quiz_css/quiz.css}"
       media="screen and (min-width: 769px)">
  <!-- Mobile CSS -->
    <link rel="stylesheet" th:href="@{/quiz_css/quiz_sp.css}">
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

</head>

<body>
<!--	æ¼¢å­—ã®æµã‚Œ-->
<div class="kanji-bg">
    <div class="kanji-item" style="top: 10%; left: -10%;">æ¼¢</div>
    <div class="kanji-item" style="top: 40%; left: -20%;">å­¦</div>
    <div class="kanji-item" style="top: 70%; left: -15%;">èª</div>
    <div class="kanji-item" style="top: 50%; left: -35%;">å„ªå‹</div>
    <div class="kanji-item" style="top: 20%; left: -35%;">çµµæ–‡å­—</div>
    <div class="kanji-item" style="top: 40%; left: -3%;">é ‘å¼µã‚Œ</div>
     
</div>

    

<!--    <! æˆ»ã‚‹ãƒœã‚¿ã‚“ -->
    <button class="back-btn" onclick="goBack()">â† æˆ»ã‚‹</button>


    <!-- Levelé¸æŠ -->
    <div id="level-screen">
        <h2>ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
        <button class="btn-level" onclick="selectLevel('N1')">N1</button>
        <button class="btn-level" onclick="selectLevel('N2')">N2</button>
        <button class="btn-level" onclick="selectLevel('N3')">N3</button>
        <button class="btn-level" onclick="selectLevel('N4')">N4</button>
        <button class="btn-level" onclick="selectLevel('N5')">N5</button>
    </div>


    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
    <div id="start-screen" class="hidden">
        <h1>ã‚¯ã‚¤ã‚ºã‚’å§‹ã‚ã‚‹</h1>
        <button class="btn-start" onclick="startQuiz()">[ Start ]</button>
    </div>

    <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
    <div id="quiz-screen" class="hidden">

        <p id="progress"></p>

        <div class="question-box">
            <h2 id="question"></h2>
        </div>

        <p id="timer"></p>

        <div id="progressBarContainer">
            <div id="progressBar"></div>
        </div>

        <p id="correctText"></p>

        <button class="option" id="opt1" onclick="choose(1)"></button>
        <button class="option" id="opt2" onclick="choose(2)"></button>
        <button class="option" id="opt3" onclick="choose(3)"></button>
        <button class="option" id="opt4" onclick="choose(4)"></button>

        <button id="nextBtn" class="btn-next" onclick="next()" disabled>Next</button>

    </div>

<!--     çµæœç”»é¢ -->
  <div id="result-screen" class="hidden">
    <h2>ğŸ‰ çµæœ ğŸ‰</h2>
    <p id="resultText" class="result-text"></p>
    <button class="btn-start" onclick="restart()">ã‚‚ã†ä¸€åº¦</button>
</div>


    <!-- JavaScriptéƒ¨åˆ† -->
    <script>

        /* ==================================================
           æˆ»ã‚‹ãƒœã‚¿ãƒ³
        ================================================== */
        let pageHistory = ["level-screen"]; // æœ€åˆç”»é¢

        function showScreen(screenId) {

            document.querySelectorAll("#level-screen, #start-screen, #quiz-screen, #result-screen")
                .forEach(s => s.classList.add("hidden"));

            document.getElementById(screenId).classList.remove("hidden");

            if (pageHistory[pageHistory.length - 1] !== screenId) {
                pageHistory.push(screenId);
            }
        }

        function goBack() {
            // levelç”»é¢ã‹ã‚‰â†’ home ã¸
            if (pageHistory.length <= 1) {
              window.location.href = "/emoji/student/home";
              return;

            }

            pageHistory.pop();//ä»Šã®ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤
            const previous = pageHistory[pageHistory.length - 1];
            showScreen(previous);
        }

        /* ===========================
           ã‚¯ã‚¤ã‚º
        ============================ */

        let selectedLevel = null;

        let questions = [];
        let index = 0;
        let score = 0;
        let correctAnswer = 0;
        let selected = 0;

        let timer = 10;
        let timerInterval;

        let showingResult = false;

        /* -------------------------------
           Fisher-Yates Shuffle
           ------------------------------- */
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /* -------------------------------
           ãƒ¬ãƒ™ãƒ«é¸æŠ
           ------------------------------- */
        function selectLevel(level) {
            selectedLevel = level;
            showScreen("start-screen");
        }

        /* -------------------------------
           ã‚¯ã‚¤ã‚ºé–‹å§‹
           ------------------------------- */
        function startQuiz() {
            fetch(`/emoji/student/api/questions?level=${selectedLevel}`)
                .then(res => res.json())
                .then(data => {

                    questions = shuffle(data).slice(0, 10); // 10å•
                    index = 0;
                    score = 0;

                    showScreen("quiz-screen");
                    showQuestion();
                });
        }

        /* -------------------------------
           å•é¡Œè¡¨ç¤º
           ------------------------------- */
        function showQuestion() {

            resetTimer();
            startTimer();

            const q = questions[index];

            document.getElementById("question").innerText = q.questionTitle;
            document.getElementById("opt1").innerText = q.questionSelect1;
            document.getElementById("opt2").innerText = q.questionSelect2;
            document.getElementById("opt3").innerText = q.questionSelect3;
            document.getElementById("opt4").innerText = q.questionSelect4;

            correctAnswer = q.answer.answerId;
            selected = 0;
            showingResult = false;

            document.getElementById("progress").innerText =
                (index + 1) + " / " + questions.length;

            document.getElementById("progressBar").style.width =
                ((index) / questions.length * 100) + "%";

            document.getElementById("correctText").innerText = "";

            document.querySelectorAll(".option").forEach(o => {
                o.classList.remove("active", "correct", "wrong");
                o.disabled = false;
            });

            document.getElementById("nextBtn").disabled = true;
        }

        /* -------------------------------
           å›ç­”é¸æŠ
           ------------------------------- */
        function choose(num) {

            clearInterval(timerInterval);
            selected = num;
            showingResult = true;

            document.querySelectorAll(".option").forEach(o => {
                o.classList.remove("active", "correct", "wrong");
                o.disabled = true;
            });

            document.getElementById("opt" + correctAnswer).classList.add("correct");

            if (num === correctAnswer) {
                score++;
                document.getElementById("opt" + num).classList.add("active");
            } else {
                document.getElementById("opt" + num).classList.add("wrong");
            }

            document.getElementById("correctText").innerText =
                "æ­£è§£ã¯ï¼š" + ["A", "B", "C", "D"][correctAnswer - 1];

            document.getElementById("nextBtn").disabled = false;
        }


        /* -------------------------------
           ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
           ------------------------------- */
        function startTimer() {
            timer = 10;
            document.getElementById("timer").innerText =
                "æ®‹ã‚Šæ™‚é–“ï¼š" + timer + "ç§’";

            timerInterval = setInterval(() => {

                timer--;
                document.getElementById("timer").innerText =
                    "æ®‹ã‚Šæ™‚é–“ï¼š" + timer + "ç§’";

                if (timer <= 0) {
                    clearInterval(timerInterval);
                    showTimeUp();
                }

            }, 1000);
        }

        /* -------------------------------
           æ™‚é–“åˆ‡ã‚Œå‡¦ç†
           ------------------------------- */
        function showTimeUp() {

            showingResult = true;

            document.getElementById("opt" + correctAnswer).classList.add("correct");

            document.querySelectorAll(".option").forEach(o => o.disabled = true);

            document.getElementById("correctText").innerText =
                "æ™‚é–“åˆ‡ã‚Œï¼æ­£è§£ã¯ï¼š" + ["A", "B", "C", "D"][correctAnswer - 1];

            document.getElementById("nextBtn").disabled = false;
        }

        function resetTimer() {
            clearInterval(timerInterval);
            document.getElementById("timer").innerText = "";
        }

        /* -------------------------------
           æ¬¡ã¸ãƒœã‚¿ãƒ³
           ------------------------------- */
        function next() {

            index++;

            if (index >= questions.length) {
                showResult();
                return;
            }

            showQuestion();
        }

        /* -------------------------------
           çµæœè¡¨ç¤º
           ------------------------------- */
	function showResult() {

    showScreen("result-screen");

    let percent = Math.round((score / questions.length) * 100);
    let message;
    let emoji;
    let resultClass;

    if (percent >= 60) {
        message = "åˆæ ¼ã€€ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚";
        emoji = "ğŸ†âœ¨";
        resultClass = "pass";
    } else {
        message = "æ®‹å¿µãªãŒã‚‰ä¸åˆæ ¼â€¦ã‚‚ã†ä¸€åº¦ç·´ç¿’ã—ã¦ä¸‹ã•ã„ã€‚";
        emoji = "ğŸ˜¢ğŸ’¦";
        resultClass = "fail";
    }

    document.getElementById("resultText").innerHTML =
        `${emoji}<br>` +
        `ã‚ãªãŸã®ç‚¹æ•°ï¼š ${score} / ${questions.length}<br>` +
        `æ­£ç­”ç‡ï¼š ${percent}%<br>` +
        `${message}`;

    
    document.getElementById("resultText").className = "result-text " + resultClass;
}

    function restart() {

    
    index = 0;
    score = 0;
    selectedLevel = null;
    questions = [];
    pageHistory = ["level-screen"]; //LEVEL ã«ã‚‚ã©ã™
    

    showScreen("level-screen");
}




    </script>
    <!-- ğŸ’¡ JSã¯ã“ã“ã ã‘ã§OKï¼ -->
	<script th:src="@{/js/theme.js}"></script>
	<!-- å…±é€šFooter -->
  <div th:replace="common/footer"></div>

</body>

</html>
